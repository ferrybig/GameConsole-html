<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="js/vendor/jquery-1.11.2.js"></script>
        <script>
            var service = "http://192.168.178.89:8080/service";
            var readIndex = 0;
            var server = "test";

            function htmlEntities(str) {
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/\\n/g, "<br>").replace(/\\\\/g, "\\");
            }


            var log = [];
            function appendLog(value, error) {
                var objDiv = document.getElementById("log");
                var log = $("#log");
                var console = $("#console");
                var shouldScroll = console[0].scrollTop <= console[0].scrollHeight;
                if (log.length >= 100) {
                    this.shift().remove();
                }
                var entry = $('<span></span>');
                entry.html(htmlEntities(value));
                if (error === 1) {
                    entry.css("color", "yellow");
                } else if (error === 2) {
                    entry.css("color", "red");
                    entry.css("font-size", "200%");
                }
                log.append(entry);
                if (shouldScroll) {
                    console.scrollTop(console[0].scrollHeight);
                }
                return log.push(entry);
            }


            function refreshLog() {
                $.ajax({
                    type: "POST",
                    url: service,
                    data: JSON.stringify(
                            {
                                "target": "server",
                                "action": "log",
                                "server": server,
                                "blocking": true,
                                "readIndex": readIndex
                            }
                    ),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        if (readIndex !== data.oldReadIndex && readIndex !== 0) {
                            appendLog("\\nBUFFER OVERRUN, skipping " + (data.oldReadIndex - readIndex) + " characters of console output\\n", 2);
                        }
                        readIndex = data.nextReadIndex;
                        if (data.log)
                            appendLog(data.log);
                        if (data.oldReadIndex === data.nextReadIndex) {
                            window.setTimeout(refreshLog, 5000);
                        } else if (data.readIndex !== data.nextReadIndex) {
                            window.setTimeout(refreshLog, 100);
                        } else {
                            window.setTimeout(refreshLog, 1000);
                        }

                    },
                    error: function (errMsg) {
                        window.setTimeout(refreshLog, 10000);
                    }
                });
            }
            $(function () {
                refreshLog();
                // this is the id of the form
                $("#command-form").submit(function (e) {
                    e.preventDefault();
                    $.ajax({
                        type: "POST",
                        url: service,
                        data: JSON.stringify(
                                {
                                    "target": "server",
                                    "action": "command",
                                    "server": server,
                                    "command": $("#command").val()
                                }
                        ),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (data)
                        {
                            $("#command").val("");
                        }
                    });
                });
            });
        </script>
    </head>
    <body style="display: flex;">
        <div id="servers">
            
        </div>
        <div id="main-console" style="height: 786px; width: 1024px; border: 1px solid black;">
            <div id="console" style="height: 750px; overflow: scroll; width: 1024px;">
                <p id="log" style="white-space: nowrap"></p>
            </div>
            <form action="#" id="command-form">
                <input type="text" id="command" style="width: 904px; height: 28px;">
                <button type="submit" style="width: 110px; height: 28px;">Send command</button>
            </form>
        </div>
    </body>
</html>
